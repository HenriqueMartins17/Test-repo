

# DataBus Data Struct数据结构

> [Back](../README.md)



## Programming Layers

[DDD 领域驱动设计：贫血模型和充血模型](https://zhuanlan.zhihu.com/p/464914100)
我们倾向于充血模型，Domain Logic 是函数过程式，便于提供给 Facade 门面。
Business Logic 是 OOP 面向对象模式，基于 Domain Logic。

| Layers                     | Data Object Acronyms                  | Code Files   | Code Traits                                                                 | Data Struct |     |
| -------------------------- | ------------------------------------- | ------------ | --------------------------------------------------------------------------- | ----------- | --- |
| Facade                     | NodeJS,Python,Java,REST-API,WidgetSDK | /databus-wasm|/databus-server | Native Binding, napi,PyO3, wasm, JNI, REST-API                              | ::init() |
| Business Logic             | BO(Business Object)                   | (暂不实现)       | Pure OOP, Widget SDK,do not implement in Rust                               | SpaceBO |
| Domain Logic               | SO(Service Object)                   | /databus-core/so/\*       | Functional Programming, get_datasheet_pack, add_records, etc.               | DatasheetPackSO |
| Operational Transformation | OTO                                   | /databus-core/ot/\*       | JSON0-based, `command`, `action`, `operation`, `changeset`, `OPEvent`, etc. | Commands, Snapshot |
| Persistent Logic           | DAO + PO                              | /databus-dao-db/\*      | `RecordDAO`, `RecordPO`, `RecordEntity`,Repository                          | DatasheetPackSO = PO + PO |
| Infrastructure             | Shared static classes                 | /databus-shared/\*   | macros, utils, helpers, libs, shared types                                  | ::prelude::* |

## Data Object Acronyms

Prior to developing DataBus, it is important to understand the various acronyms of `Data Objects`.

| Acronym        | Definition                                                                                                                                                                             |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| DTO            | Data Transfer Object. A design pattern used to transfer data between software application subsystems.                                                                                  |
| <u>**DAO**</u> | Data Access Object. A design pattern that provides an abstract interface to some type of database or other persistence mechanism.                                                      |
| <u>**PO**</u>  | Persistent Object. An object that is stored in a database and retains its state even after the application that created it has terminated.                                             |
| <u>**OTO**</u> | Operational Transformation Object. Snapshot, Command, Operation, Action, etc.                                                                                                          |
| <u>**SO**</u>  | Service Object. An object that provides a specific service or functionality to other objects or components within an application: DatasheetPack, DatashetPackManager, etc.             |
| <u>**BO**</u>  | Business Object. An object that represents a business entity or concept, such as a customer, order, or product.                                                                        |
| VO             | View Object. An object that represents a value or set of values, but does not have any behavior associated with it. Typically used to transfer data between layers of an application. |

> Table above generated by ChatGPT.

There's only **DAO / PO / OTO / SO** in `DataBus-core`, **BOs** in `DataBus-bindings`.

Let's simplify them for better understanding:

```mermaid
flowchart LR
  DAO --A1.从数据库读出--> PO --A2.组装成--> SO --A3.字段计算--> VO --> FusionAPI返回or前端React渲染


  OTO --B1.进行实时协同操作--> VO --B2.拆解计算--> SO --B3.分解数据库对象--> PO --B4.落盘保存--> DAO

```


## Data Structure Class Diagram

### Service Objects & OT Objects & JSON0 & Persistent Objects

通常的后端编程，从数据库获取PO后，就转变成VO或DTO，返回给请求端了。
但是我们是实时协同，这里发生了更复杂的对象拆分和转换。

- PO: Persistent Object，持久化数据库里的；
- SO: Service Objects，内存里的，做关联计算的；
- OTO: OT Objects，做OT算法操作修改的；
- JSON0: 底层库
- JO: 是打了#[wasm_bindgen] 宏tag的结构体，专门用于WebAssembly接口返回，它通常映照VO、SO。

以下是各种数据流程，方便你理解。

### `APIs`接口加载何种`DatasheetPack`，并返回`VOs`
```mermaid

classDiagram
  class LoaderAPI {
      // base api. called by wasm and databus-server
    +get_datasheet_pack(dsi_id: string): DatasheetPackSO
    +get_datasheet_revision(dst_id: string): i32
    +cache_snapshot(key: string, value: DatasheetPackSO, new_version: i32): bool
    +get_snapshot_from_cache(key: string) -> DatasheetPackSO
  }

  class InternalAPI {
      // implement in databus-server
    +get_datasheet_pack(dst_id: string): DatasheetPackSO
    +get_ai(ai_id: string): AiPO
    +dao_get_ai_datasheet_ids(ai_id: string): List[string]
    ...
  }

  class OpenAPI_FusionAPI {
    _get_datasheet_pack(): DatasheetPackVO
    +get_records(dst_id: string): List[RecordVO]
    +set_records(dst_id: string, record: RecordVO): bool[XXXVO]
  }

  class WebAssembly_API {
    // implement by wasm
    +get_datasheet_pack(): DatasheetPackSO(JO)
    +get_datasheet_pack_vo(): DatasheetPackVO(JO)
    +get_records: List[RecordVO(JO)]

  }

  class DataBusServer {
    type DatasheetPackSO
    type DatasheetPackVO
  }
  class DataBusWASM {
    type DatasheetPackSO_JO
    type DatasheetPackVO_JO

  }
  class DataBusCore {
    type DatasheetPackSO
  }
  class DataBusDAO {
    type DatasheetPackSO
    type POs
  }
  
  InternalAPI --> DataBusServer
  DataBusServer --> DataBusCore
  DataBusCore --> DataBusDAO

  WebAssembly_API --> DataBusWASM
  DataBusWASM --> DataBusCore

  OpenAPI_FusionAPI --> DataBusServer

  LoaderAPI --> DataBusDAO
  LoaderAPI --> DataBusCore
```

### `DatasheetPackSO` 经过字段计算形成 `DatasheetPackVO`

经过字段计算，生成DatasheetVO。
DatasheetVO，是计算之后，前端React，可直接用来渲染的。

何为没有经过**字段计算**？（SO）

1. 关联字段的关联整个record，而不是可直接渲染的文本信息
2. 单选字段，仍然是"opt_"开头值的ID，而不是可渲染的文本信息
3. 公式字段，仅仅是公式，而不是可渲染的文本信息
4. ....

```mermaid


classDiagram


  class NodeSO {
    -id: string
    -name: string
    -description: string
    -parent_id: string
    -icon: string
    -node_shared: bool
    -node_permit_set: bool
    -node_favorite: bool
    -space_id: string
    -role: string
    -permissions: NodePermissionStateSO
    -revision: u32
  }
  
  class Formulas {
    Add
    Minus
    ...
  }

  class DatasheetSnapshotSO {
    -meta: DatasheetMetaSO
    -record_map: Map[string, RecordSO]
    -datasheet_id: String
  }

  class RecordSO {
      +id: String,
      +data: CellValue,
      +comment_count: u32,
      +record_meta: Json,
      +revision_history: Vec<u32>,
      +created_at: i64,
      +updated_at: i64,
  }

  class MetaVO {
    -views: List[ViewSO]
    -field_map: Map[FieldSO]
    -widget_panel: Optional[List[Value]] "option"
  }
  class RecordVO {
    - ......

  }
  
  class CellValue{
    -value: String | Number | Bool | String[]
    +r#type: i32,
    +id: String,
    +name: String,
    +mime_type: String,
    +bucket: String,
    +preview: String,
    +text: String,
    +link: String,
    +title: String,
    +token: String,
    +favicon: String,
    +mention_notify: bool,
    +mention_type: i32,
    +width: i32,
    +height: i32,
    +size: i32,
    +visited: bool,
  }

  class ViewSO {
    +id: String,
    +name: String,
    +r#type: u64, 
    +columns: Vec<ViewColumnSO>,
    +rows: Vec<ViewRowSO>,
    +filter_info: IFilterInfo,
    +sort_info: ISortInfo,
    +lock_info: IViewLockInfo,
    +display_hidden_column_within_mirror: bool,
    +auto_save: bool,
    +description: String,
    +hidden: bool,
    +group_info: IGroupInfo,
    +frozen_column_count: i32,
    +row_height_level: i32,
    +auto_head_height: bool,
    +style: ViewStyleSo,
  }

    class DatasheetMetaSO {
        +field_map: Map<string, FieldSO>, 
        +views: Vec<ViewSO>, 
        +widget_panels: Vec<WidgetPanelSO>,
    }
    
    class FieldSO{
        +id: String, 
        +name: String, 
        +desc: String, 
        +required: bool,
        +kind: FieldKindSO, 
        +property: Json,
    }
    
    class WidgetPanelSO{
        +id: String,
        +widgets: Vec<WidgetInPanelSO>,
        +others: Json,
    }
    
    class WidgetInPanelSO{
        +id: String,
        +others: Json,
    }

  class FieldsManager {
    LinkField
    AttachmentField
    NumberField
  }



    class DatasheetPackSO {
        +snapshot: DatasheetSnapshotSO
        +datasheet: NodeSO
        +field_permission_map: NodeSO
        +foreign_datasheet_map: Map[string, DatasheetPackSO]
        +units: List[UnitSO]
    }

    class DatasheetPackVO {
        -snapshot: SnapshotSO
        -datasheet: NodeSO
        -...: more
        ::new_from_po(po: DatasheetPackSO): Self
        .to_po(): DatasheetPackSO
    }


  CellValue o-- RecordSO: "data"
  DatasheetMetaSO --o DatasheetSnapshotSO: "meta"
  RecordSO --o DatasheetSnapshotSO: "record_map"
  FieldSO --o DatasheetMetaSO: "field_map"
  ViewSO --o DatasheetMetaSO: "views"
  WidgetPanelSO --o DatasheetMetaSO: "widget_panels"
  DatasheetSnapshotSO --o DatasheetPackSO: "snapshot"
  NodeSO --o DatasheetPackSO: "datasheet"

%%  DatasheetPackSO --> DatasheetPackVO: "DatasheetPackSO reads from database or from APIs"



  MetaVO <-- ViewVO: ""
  FieldVO --> MetaVO: ""
  RecordVO -->SnapshotVO: ""
```

### `数据库POs` 组装成 `DatasheetPackSO`

```mermaid
classDiagram

  class AiPO {
    +ai_id: String,
    +type: String,
    +name: String,
    +model: String,
    +prompt: String,
    +setting: String,
    +prologue: String,
  }
  class AutomationPO {
      +id: u64,
      +robot_id: String,
      +trigger_id: String,
      +trigger_type_id: String,
      +input: Json,
      +is_deleted: u8,
      +created_by: u64,
      +updated_by: u64,
      +created_at: NaiveDateTime,
      +updated_at: NaiveDateTime,
  }
  class NodePO {
      +id: i64,
      +space_id: String,
      +parent_id: String,
      +pre_node_id: String,
      +node_id: String,
      +icon: String,
      +extra: Value,
      +r#type: i32,
      +node_name: String,
      +cover: String,
      +deleted_path: String,
      +is_template: bool,
      +is_rubbish: bool,
      +is_banned: bool,
      +is_deleted: bool,
      +comment_msg: Value,
      +field_updated_info: Value,
      +revision: i64,
  }

  class DatasheetPO {
      +id: i64,
      +creator: i64,
      +revision: i64,
      +dst_id: String,
      +node_id: String,
      +dst_name: String,
      +space_id: String,
  }

  class DatasheetMetaPO {
      +id: i64,
      +meta_data: Value,
      +revision: i64,
      +dst_id: String,
  }

  class DatasheetRecordPO {
      +id: i64,
      +data: Value,
      +field_updated_info: Value,
      +revision: i64,
      +dst_id: String,
      +record_id: String,
      +revision_history: String,
  }

  class DatasheetRecordCommentPO {
      +id: i64,
      +comment_msg: Value,
      +field_updated_info: Value,
      +revision: i64,
      +dst_id: String,
      +record_id: String,
      +comment_id: String,
      +revision_history: String,
  }

  class DatasheetPackSO {
    +snapshot: DatasheetSnapshotSO
    +datasheet: NodeSO
    +field_permission_map: NodeSO
    +foreign_datasheet_map: Map[string, DatasheetPackSO]
    +units: List[UnitSO]
  }


  NodePO --o DatasheetPackSO: ""
  DatasheetPO --o DatasheetPackSO: ""
  DatasheetMetaPO --o DatasheetPackSO: ""
  DatasheetRecordPO --o DatasheetPackSO: ""
    DatasheetRecordCommentPO --o DatasheetPackSO: ""

```

### `OTO` (Operational Transform Objects) 组合和封装 `JSON0`

增删改生成changeset。

```mermaid
classDiagram

  class ChangesetOTO {
    -message_id: string
    -resource_type: ResourceType
    -resource_id: string
    -operations: List[Operation]
  }

  class OperationOTO {
    -cmd: string
    -actions: List[Action]
    -mainLinkDstId: string
    -fieldTypeMap: map[FieldType]
    -resourceType: ResourceType
    -revision: Optional[number]
  }

  class ResourceType {
    enum Datasheet
    enum Form
    enum Dashboard
    enum Widget
    enum Mirror
  }

  class CommandOTO {
    -AddRecord: command "datasheet_id,xxx"
    -AddField: command "datasheet_id,xxx"
  }

  class ActionOTO {
    -op_name: string
    -operations: List[Operation] "待定"
  }

    class JSON0 {
      +apply(snapshot, operation)
      +compose(op1, op2)
      +invert(op)
      +transform(op1, op2, side)
      +transform_x(left_op, right_op)
    }

    class JSON0_PathSegment {
      enum String
      enum Number
    }

    class JSON0_Operation {
      -p: Vec[JSON0_PathSegment]
      -kind: JSON0_OperationKind
    }

    class JSON0_OperationKind {
      -NumberAdd: action "na"
      -ListReplace: action "ld, li"
      -ListInsert: action "li"
      -ListDelete: action "ld"
      -ListMove: action "lm"
      -SubtypeOperation: action "t, o"
      -StringInsert: action "si"
      -StringDelete: action "sd"
      -ObjectReplace: action "od, oi"
      -ObjectInsert: action "oi"
      -ObjectDelete: action "od"
    }
  
  ChangesetOTO --> OperationOTO: "contains"
  OperationOTO <-- ResourceType: "includes"
  OperationOTO --> CommandOTO: "contains"
  CommandOTO --> ActionOTO: "Action"
  ActionOTO --> JSON0_Operation: "same as IOTAction, OTAction"
  JSON0 <-- JSON0_Operation: "low-level lib"
  JSON0_Operation <-- JSON0_PathSegment: "p"
  JSON0_Operation <-- JSON0_OperationKind: "kind"
```

### 从`OTO`应用修改 -> `DatasheetPackVO` -> `DatasheetPackSO` -> `POs`

增/删/改流程，应用Changeset。

```mermaid

classDiagram
  class ChangesetOTO {
    - ......
  }
  class SnapshotVO {
    - ......
  }
  class DatasheetPackVO {
    - ......
  }
  class DatasheetPackSO {
    - ......
  }
  class NodeSO {
    - .......
  }
  class DatasheetSO {
    - ......
  }
  ChangesetOTO --> SnapshotSO: "JSON0 apply"
  SnapshotSO --> DatasheetPackVO: ""
  DatasheetPackVO --> DatasheetPackSO: ""
  DatasheetPackSO --> NodePO: ""
  DatasheetPackSO --> DatasheetPO: ""



```