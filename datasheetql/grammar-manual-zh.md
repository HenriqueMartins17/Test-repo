# DatasheetQL 语法手册

其他语言：[English](./grammar-manual.md)

DatasheetQL 源文件由 0 个或多个 DatasheetQL 语句组成，语句之间使用 `;` 分隔，最后一个语句末尾可以用 `;` 结尾（可选）。

<!-- toc -->

- [词法规则](#%E8%AF%8D%E6%B3%95%E8%A7%84%E5%88%99)
- [创建表格](#%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%A0%BC)
  * [表格修饰符](#%E8%A1%A8%E6%A0%BC%E4%BF%AE%E9%A5%B0%E7%AC%A6)
    + [注释](#%E6%B3%A8%E9%87%8A)
  * [字段声明](#%E5%AD%97%E6%AE%B5%E5%A3%B0%E6%98%8E)
    + [字段修饰符](#%E5%AD%97%E6%AE%B5%E4%BF%AE%E9%A5%B0%E7%AC%A6)
      - [主键](#%E4%B8%BB%E9%94%AE)
      - [注释](#%E6%B3%A8%E9%87%8A-1)
      - [默认值](#%E9%BB%98%E8%AE%A4%E5%80%BC)
    + [字段类型](#%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B)
      - [单行文本](#%E5%8D%95%E8%A1%8C%E6%96%87%E6%9C%AC)
      - [多行文本](#%E5%A4%9A%E8%A1%8C%E6%96%87%E6%9C%AC)
      - [选择](#%E9%80%89%E6%8B%A9)
      - [数字](#%E6%95%B0%E5%AD%97)
      - [货币](#%E8%B4%A7%E5%B8%81)
      - [百分比](#%E7%99%BE%E5%88%86%E6%AF%94)
      - [日期时间](#%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4)
      - [附件](#%E9%99%84%E4%BB%B6)
      - [成员](#%E6%88%90%E5%91%98)
      - [勾选](#%E5%8B%BE%E9%80%89)
      - [评分](#%E8%AF%84%E5%88%86)
      - [网址](#%E7%BD%91%E5%9D%80)
      - [电话号码](#%E7%94%B5%E8%AF%9D%E5%8F%B7%E7%A0%81)
      - [电子邮箱](#%E7%94%B5%E5%AD%90%E9%82%AE%E7%AE%B1)
      - [神奇关联](#%E7%A5%9E%E5%A5%87%E5%85%B3%E8%81%94)
      - [神奇引用](#%E7%A5%9E%E5%A5%87%E5%BC%95%E7%94%A8)
      - [智能公式](#%E6%99%BA%E8%83%BD%E5%85%AC%E5%BC%8F)
      - [自增数字](#%E8%87%AA%E5%A2%9E%E6%95%B0%E5%AD%97)
      - [创建时间](#%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4)
      - [修改时间](#%E4%BF%AE%E6%94%B9%E6%97%B6%E9%97%B4)
      - [创建人](#%E5%88%9B%E5%BB%BA%E4%BA%BA)
      - [修改人](#%E4%BF%AE%E6%94%B9%E4%BA%BA)
- [表达式](#%E8%A1%A8%E8%BE%BE%E5%BC%8F)
  * [常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)
  * [筛选表达式](#%E7%AD%9B%E9%80%89%E8%A1%A8%E8%BE%BE%E5%BC%8F)
  * [智能公式表达式](#%E6%99%BA%E8%83%BD%E5%85%AC%E5%BC%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)
  * [运算符](#%E8%BF%90%E7%AE%97%E7%AC%A6)

<!-- tocstop -->

## 词法规则

- 所有关键字不区分大小写，但表名、字段名、视图名区分大小写。
- 标识符（表名、字段名等）的格式：
  + 以字母（Unicode 字母，不局限于英文字母）或下划线开头，后面跟上 0 个或多个字母、数字、下划线（不局限于英文字母和数字）。  
  + 使用花括号，例：`{🥰 ㏴}`，以这种方式可以使用非字母和数字的字符，例如 emoji、空格等。  
    如果名称中包含右花括号，需要使用 `\` 转义，例：`{{A\}}` 表示的名称是 `{A}`。  
    如果包含 `\` 字符本身，也需要用 `\` 转义，例：`{1\\2}` 表示的名称是 `1\2`。
- 字符串使用双引号，例：`"abc"`。  
  转义符：
  + `\\` 表示 `\`
  + `\n` 表示换行
  + `\"` 表示双引号。
- 单行注释以 `--` 开头，`--` 之后直到该行结束为止，都是注释内容。

## 创建表格

创建单张表格：

```sql
CREATE TABLE 表名 ( 字段列表 ) 表格修饰符
```

同时创建多张表（表之间可以相互关联）：

```sql
CREATE TABLE 表名1 ( 字段列表 ) 表格修饰符 AND TABLE 表名2 ( 字段列表 ) ...
```

- `表格修饰符` 是可选的。
- `字段列表` 是使用逗号分隔的 1 个或多个字段声明。
- 一张表中的字段名必须唯一。
- 如果指定为主键的字段不是第一个字段，则在创建表时自动把该字段提前到第一个字段。
- 一张表中必须有**一个**主键。
- 在字段列表末尾可以使用 `PRIMARY KEY 字段名` 指定主键字段（`KEY` 可以省略），例：
  ```sql
  CREATE TABLE 示例表1 ( 字段1 TEXT, 字段2 NUMBER, PRIMARY KEY 字段1 )
  ```
- 同时创建多张表时，除了第一张表之外，后续的表名之前的 `TABLE` 关键字可以省略，例：
  ```sql
  CREATE TABLE 示例表1 ( 字段1 CURRENCY PRIMARY KEY ) AND 示例表2 ( 字段1 TEXT )
  ```

### 表格修饰符

#### 注释

语法形式：

```sql
COMMENT 注释表达式
```

其中 `注释表达式` 是[常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)，计算结果必须是一个字符串，作为表格的描述信息。

例：

```sql
CREATE TABLE 表1 (
  字段1 NUMBER PRIMARY KEY
) COMMENT "表格注释";
```

### 字段声明

语法形式：

```sql
字段名 字段类型 字段修饰符列表
```

其中 `字段修饰符列表` 是使用空格分隔的 0 个或多个字段修饰符。

例：

```sql
字段1 CURRENCY UNIT "元/千克"
```

#### 字段修饰符

##### 主键

语法形式：

```sql
PRIMARY KEY
```

其中 `KEY` 可以省略。一张表必须有一个主键。

能够作为主键的字段类型：单行文本，多行文本，数字，货币，百分比，日期，网址，电话，邮箱，智能公式，自增数字。

例：

```sql
CREATE TABLE 表1 (
  字段1 NUMBER PRIMARY KEY
);
```

##### 注释

语法形式：

```sql
COMMENT 注释表达式
```

其中 `注释表达式` 是[常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)，计算结果必须是一个字符串，作为字段的描述信息。

例：

```sql
CREATE TABLE 表1 (
  字段1 NUMBER PRIMARY KEY
);
```

##### 默认值

语法形式：

```sql
DEFAULT 默认值表达式
```

其中 `默认值表达式` 会在创建表格之前计算得出结果，所以不能引用任何字段的值。计算结果的类型必须和字段类型匹配。

允许指定默认值的字段类型：单行文本，单选，多选，数字，货币，百分比。

多选字段默认值暂不支持指定多个选项。

如果字段是日期时间类型，则可以指定特殊的默认值 `AUTO`，表示插入记录时自动把当前日期时间填写到该字段。

例：

```sql
CREATE TABLE 表1 (
  字段1 TEXT DEFAULT ("foo" & "bar"),
  字段2 DATETIME DEFAULT AUTO
);
```

#### 字段类型

##### 单行文本

语法形式：

```sql
TEXT
```

##### 多行文本

语法形式：

```sql
LONG TEXT
```

或

```sql
MULTILINE TEXT
```

或

```sql
MULTI LINE TEXT
```

##### 选择

单选：

```sql
CHOICE 选择修饰符列表
```

多选：

```sql
MULTI CHOICE 选择修饰符列表
```

其中 `选择修饰符列表` 是用空格分隔的 0 个或多个选择字段修饰符。

**选择修饰符**：

- `( 选项列表 )`：选项列表是用逗号分隔的 0 个或多个选项，每个选项是一个字符串类型的[常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)或者标识符。  
  限制：选项列表中的选项不能重复，但是维格表中的单选/多选选项允许重复。
- `MULTI`：将选择字段变成多选。  
  和上面的 `MULTI CHOICE` 作用相同，因此 `CHOICE (男, 女) MULTI` 这种字段声明和 `MULTI CHOICE (男, 女)` 是等价的。

##### 数字

语法形式：

```sql
NUMBER 精度 数字修饰符列表
```

其中 `精度` 是数字类型的常量表达式，计算结果必须为 `1`、`0.1`、`0.01`、`0.001` 或 `0.0001`；精度是可选的，默认精度是 `1`。`数字修饰符列表` 是用空格分隔的 0 个或多个数字字段修饰符。

**数字修饰符**：

- `PRECISION 精度`：与上面的 `精度` 作用相同。
- `UNIT 单位`：指定数字的单位。`单位` 是字符串类型的[常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)，并且可以使用[货币](#%E8%B4%A7%E5%B8%81)字段的货币助记符，例如 `CNY`、`RMB` 等。例：`字段1 NUMBER UNIT RMB`
- `SEPARATOR`：显示千位分隔符。

##### 货币

语法形式：

```sql
CURRENCY 精度 货币修饰符列表
```

其中 `精度` 是数字类型的常量表达式，计算结果必须为 `1`、`0.1`、`0.01`、`0.001` 或 `0.0001`；精度是可选的，默认精度是 `1`。`货币修饰符列表` 是用空格分隔的 0 个或多个货币字段修饰符。

**货币修饰符**：

- `UNIT 单位`：指定货币的单位。`单位` 是字符串类型的[常量表达式](#%E5%B8%B8%E9%87%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F)，并且可以使用货币助记符（下表）。
- `LEFT`：货币符号显示在数字左边。和 `RIGHT` 修饰符是互斥的，两者不能同时出现。
- `RIGHT`：货币符号显示在数字右边。和 `LEFT` 修饰符是互斥的，两者不能同时出现。

**货币助记符**：

|    名称    | 符号 |
| :--------: | :--: |
| CNY 或 RMB |  ￥  |
|    JPY     |  ￥  |
|    USD     |  ＄  |
|    EUR     |  €   |
|    GBP     |  ￡  |

在 `单位` 表达式中出现的货币助记符名称将会被替换成对应的货币符号，并且助记符能够参与运算，例如 `CNY & "/kg"` 的运算结果是 `￥/kg`。

货币助记符不区分大小写，例如 `cny` 与 `CNY` 等价。

##### 百分比

语法形式：

```sql
PERCENTAGE 精度 百分比修饰符列表
```

其中 `精度` 是数字类型的常量表达式，计算结果必须为 `1`、`0.1`、`0.01`、`0.001` 或 `0.0001`；精度是可选的，默认精度是 `1`。`百分比修饰符列表` 是用空格分隔的 0 个或多个百分比字段修饰符。

**百分比修饰符**：

- `PRECISION 精度`：与上面的 `精度` 作用相同。

##### 日期时间

语法形式：

```sql
DATETIME 日期时间格式
```

其中 `日期时间格式` 是字符串类型的常量表达式，可选。

日期时间格式: 日期格式 + 时间格式，不需要分隔字符；时间格式是可选的，如果省略时间格式，则不会显示时间。

**日期格式**：

- `年/月/日` 或 `YYYY/MM/DD`, 例：`2022/04/28`
- `年-月-日` 或 `YYYY-MM-DD`, 例：`2022-04-28`
- `日/月/年` 或 `DD/MM/YYYY`, 例：`28/04/2022`
- `年-月` 或 `YYYY-MM`, 例：`2022-04`
- `月-日` 或 `MM-DD`, 例：`04-28`
- `年` 或 `YYYY`, 例：`2022`
- `月` 或 `MM`, 例：`04`
- `日` 或 `DD`, 例：`28`

**时间格式**：

- `12小时` 或 `12时` 或 `hh:mm`：时间显示为 12 小时格式(AM/PM)
- `24小时` 或 `24时` 或 `HH:mm`：时间显示为 24 小时格式

例：`"年/月/日"`，`"YYYY-MM-DD HH:mm"`。格式中可以适当添加空格以提高可读性。

##### 附件

语法形式：

```sql
FILE
```

##### 成员

只允许选择单个成员：

```sql
MEMBER 成员修饰符列表
```

允许选择多个成员：

```sql
MULTI MEMBER 成员修饰符列表
```

其中 `成员修饰符列表` 是用空格分隔的 0 个或多个成员字段修饰符。

**成员修饰符**：

- `NOTIFY`：选择成员后发送通知消息。
- `MULTI`：允许选择多个成员。  
  和上面的 `MULTI MEMBER` 作用相同，因此 `MEMBER NOTIFY MULTI` 这种字段声明和 `MULTI MEMBER NOTIFY` 是等价的。

##### 勾选

语法形式：

```sql
CHECKBOX 勾选符号
```

其中 `勾选符号` 是字符串类型的常量表达式，计算结果必须是一个emoji；可选。

##### 评分

语法形式：

```sql
RATING 评分符号 评分修饰符列表
```

其中 `评分符号` 是字符串类型的常量表达式，计算结果必须是一个emoji；可选。`评分修饰符列表` 是用空格分隔的 0 个或多个评分字段修饰符。

**评分修饰符**：

- `MAX 最高评分`：指定评分的最大值。`最高评分` 是数字类型的常量表达式，计算结果必须为 1 到 10 之间的整数（含 1 和 10）。

##### 网址

语法形式：

```sql
URL 网址修饰符列表
```

其中 `网址修饰符列表` 是用空格分隔的 0 个或多个网址字段修饰符。

**网址修饰符**：

- `TITLE`：显示网页标题。

##### 电话号码

语法形式：

```sql
PHONE
```

##### 电子邮箱

语法形式：

```sql
EMAIL
```

##### 神奇关联

只允许关联一条记录：

```sql
LINK 关联修饰符列表
```

允许关联多条记录：

```sql
MULTI LINK 关联修饰符列表
```

其中 `关联修饰符列表` 是用空格分隔的 0 个或多个神奇关联字段修饰符。

**关联修饰符**：

- `TO 表名`：指定关联到某张表。这个修饰符必须出现一次。`TO` 关键字可以省略。
- `VIA VIEW 视图名`：指定通过某个视图筛选记录。
- `MULTI`：允许关联多条记录。  
  和上面的 `MULTI LINK` 作用相同，因此 `LINK TO 表名 MULTI` 这种字段声明和 `MULTI LINK TO 表名` 是等价的。

##### 神奇引用

语法形式：

```sql
LOOKUP 关联字段名 引用修饰符列表
```

其中 `关联字段名` 是本表中类型为神奇关联的字段。`引用修饰符列表` 是用空格分隔的 0 个或多个神奇引用字段修饰符。

限制：暂不支持指定统计函数的输出格式。

**引用修饰符**：

- `WHEN 筛选条件`：指定神奇引用的筛选条件。`筛选条件` 是布尔类型的[筛选表达式](#%E7%AD%9B%E9%80%89%E8%A1%A8%E8%BE%BE%E5%BC%8F)。
- `统计函数名称 OF 统计字段名`：指定展示的统计方式。这个修饰符必须出现一次。
  可用的统计函数：
  + `VALUES`：原样引用
  + `AVERAGE`：平均数
  + `COUNT`：非空数值计数
  + `COUNTA`：非空值计数
  + `COUNTALL`：全计数
  + `SUM`：求和
  + `MAX`：最大值
  + `MIN`：最小值
  + `AND`：*逻辑与*运算
  + `OR`：*逻辑或*运算
  + `XOR`：*逻辑异或*运算
  + `CONCATENATE`：连接成文本
  + `ARRAYJOIN`：逗号连接
  + `ARRAYUNIQUE`：去重
  + `ARRAYCOMPACT`：过滤所有空值

##### 智能公式

语法形式：

```sql
FORMULA 公式表达式 公式修饰符列表
```

其中 `公式表达式` 是[智能公式表达式](#智能公式表达式)。`公式修饰符列表` 是用空格分隔的 0 个或多个智能公式字段修饰符。

**公式修饰符**：

- `NUMBER`：指定公式结果显示为数字。只有当公式结果是数字类型时，才能使用这个修饰符。
- `CURRENCY`：指定公式结果显示为货币。只有当公式结果是数字类型时，才能使用这个修饰符。
- `PERCENTAGE`：指定公式结果显示为百分比。只有当公式结果是数字类型时，才能使用这个修饰符。
- `PRECISION 精度`：指定数字、货币或百分比的精度。只有指定了 `NUMBER`、`CURRENCY` 或 `PERCENTAGE` 修饰符时，才能使用这个修饰符。
- `UNIT 单位`：指定货币的单位。只有指定了 `CURRENCY` 修饰符时，才能使用这个修饰符。
- `SEPARATOR`：指定数字显示千位分隔符。只有指定了 `NUMBER` 修饰符时，才能使用这个修饰符。
- `DATETIME`：公式结果显示为日期时间。只有当公式结果是日期时间类型时，才能使用这个修饰符。
- `DATETIME 日期时间格式`：公式结果显示为指定格式的日期时间。只有当公式结果是日期时间类型时，才能使用这个修饰符。

##### 自增数字

语法形式：

```sql
AUTO NUMBER
```

##### 创建时间

语法形式：

```sql
CREATED DATETIME 日期时间格式
```

或

```sql
DATETIME CREATED 日期时间格式
```

其中 `日期时间格式` 是可选的。

##### 修改时间

语法形式：

```sql
MODIFIED DATETIME 日期时间格式 修改时间修饰符列表
```

或

```sql
DATETIME MODIFIED 日期时间格式 修改时间修饰符列表
```

其中 `日期时间格式` 是可选的。`修改时间修饰符列表` 是用空格分隔的 0 个或多个修改时间字段修饰符。

**修改时间修饰符**：

- `OF ( 字段名列表 )`：修改指定的字段时，才更新该字段的修改时间。`字段名列表` 是逗号分隔的 1 个或多个字段名。

##### 创建人

语法形式：

```sql
CREATOR
```

##### 修改人

语法形式：

```sql
MODIFIER 修改人修饰符列表
```

其中 `修改人修饰符列表` 是用空格分隔的 0 个或多个修改人字段修饰符。

**修改人修饰符**：

- `OF ( 字段名列表 )`：修改指定的字段时，才更新该字段的修改人。`字段名列表` 是逗号分隔的 1 个或多个字段名。

## 表达式

DatasheetQL 中的表达式不同的使用场景，不同场景的表达式形式、约束不尽相同。

### 常量表达式

在编译期就会计算出结果的表达式，因此不能引用任何字段的值。

### 筛选表达式

用于神奇引用字段的筛选条件。由于 Fusion API 不支持指定筛选条件，该表达式场景暂未实现。

### 智能公式表达式

能够引用其他字段，也能够使用维格表智能公式的所有函数。

### 运算符

表格中的运算符按优先级从高到低排列，表格同一行的运算符优先级相同。

| 运算符类别 | 结合性 | 运算符                                                                                |
| :--------- | :----: | :------------------------------------------------------------------------------------ |
| 单目运算符 | 右结合 | `+`：将运算数转换为数字类型<br>`-`：取负数<br>`NOT` 或 `!`：逻辑非                   |
| 乘除法     | 左结合 | `*`：乘法<br>`/`：除法<br>`%`：取余数                                                 |
| 加减法     | 左结合 | `+`：加法或连接字符串<br>`-`：减法                                                    |
| 字符串操作 | 左结合 | `&`：连接字符串                                                                       |
| 关系运算   | 左结合 | `=`：相等<br>`!=`：不等<br>`>`：大于<br>`<`：小于<br>`>=`：大于等于<br>`<=`：小于等于 |
| 逻辑运算   | 左结合 | `AND` 或 `&&`：逻辑与                                                                 |
| 逻辑运算   | 左结合 | `OR` 或 <code>&#124;&#124;</code>：逻辑或                                             |
